// Application CI/CD Pipeline
// Builds Docker images, pushes to ECR, and deploys to EKS

pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: docker
    image: docker:dind
    securityContext:
      privileged: true
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
  - name: kubectl
    image: alpine/helm:latest
    command: ['sleep']
    args: ['infinity']
"""
        }
    }
    
    environment {
        AWS_REGION = 'us-east-2'
        ECR_REGISTRY = '586794447516.dkr.ecr.us-east-2.amazonaws.com'
        ECR_REPOSITORY = 'platform-app'
        APP_NAME = 'chatbot'
        BACKEND_IMAGE_TAG = "${env.BUILD_NUMBER}-backend"
        FRONTEND_IMAGE_TAG = "${env.BUILD_NUMBER}-frontend"
    }
    
    stages {
        stage('Build Images') {
            steps {
                container('docker') {
                    sh """
                        timeout 60 sh -c 'until docker info; do sleep 1; done'
                        cd backend && docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG} .
                        cd ../frontend && docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG} .
                    """
                }
            }
        }
        
        stage('Push to ECR') {
            steps {
                container('docker') {
                    sh """
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG}
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Deploy to EKS') {
            steps {
                container('kubectl') {
                    sh """
                        helm upgrade --install ${APP_NAME} ./k8s \
                          -f k8s/values-${TARGET_ENVIRONMENT}.yaml \
                          --set backend.image=${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG} \
                          --set frontend.image=${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG} \
                          --namespace default
                    """
                }
            }
        }
        
        stage('Verify') {
            steps {
                container('kubectl') {
                    sh """
                        kubectl rollout status deployment/chatbot-backend-deployment --timeout=5m
                        kubectl get pods -l app=chatbot-backend
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "✅ Deployment successful: ${BACKEND_IMAGE_TAG}, ${FRONTEND_IMAGE_TAG}"
        }
        failure {
            echo "❌ Pipeline failed"
        }
    }
}
