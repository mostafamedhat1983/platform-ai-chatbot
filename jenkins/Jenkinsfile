// Application CI/CD Pipeline
// Builds Docker images, pushes to ECR, and deploys to EKS

pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: docker
    image: docker:dind
    securityContext:
      privileged: true
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
  - name: kubectl
    image: alpine/k8s:1.30.7
    command: ['cat']
    tty: true
"""
        }
    }
    
    environment {
        AWS_REGION = 'us-east-2'
        ECR_REGISTRY = '586794447516.dkr.ecr.us-east-2.amazonaws.com'
        ECR_REPOSITORY = 'platform-app'
        APP_NAME = 'chatbot'
        BACKEND_IMAGE_TAG = "${env.BUILD_NUMBER}-backend"
        FRONTEND_IMAGE_TAG = "${env.BUILD_NUMBER}-frontend"
    }
    
    stages {
        stage('Build Images') {
            steps {
                container('docker') {
                    sh """
                        while ! docker info >/dev/null 2>&1; do sleep 1; done
                        cd backend && docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG} .
                        cd ../frontend && docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG} .
                    """
                }
            }
        }
        
        stage('Push to ECR') {
            steps {
                container('docker') {
                    sh """
                        apk add --no-cache aws-cli
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG}
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                container('docker') {
                    sh """
                        apk add --no-cache trivy
                        
                        # Scan and fail on CRITICAL vulnerabilities
                        trivy image --severity CRITICAL --exit-code 1 ${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG}
                        trivy image --severity CRITICAL --exit-code 1 ${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG}
                        
                        # Generate full reports for archiving
                        trivy image --format json --output backend-scan.json ${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG}
                        trivy image --format json --output frontend-scan.json ${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Deploy to EKS') {
            steps {
                container('kubectl') {
                    sh """
                        helm upgrade --install ${APP_NAME} ./k8s \
                          -f k8s/values-${TARGET_ENVIRONMENT}.yaml \
                          --set backend.image=${ECR_REGISTRY}/${ECR_REPOSITORY}:${BACKEND_IMAGE_TAG} \
                          --set frontend.image=${ECR_REGISTRY}/${ECR_REPOSITORY}:${FRONTEND_IMAGE_TAG} \
                          --namespace default
                    """
                }
            }
        }
        
        stage('Verify') {
            steps {
                container('kubectl') {
                    sh """
                        kubectl get pods -l app=chatbot-backend
                        kubectl get pods -l app=chatbot-frontend
                    """
                }
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: '*-scan.json', allowEmptyArchive: true
        }
        success {
            echo "✅ Deployment successful: ${BACKEND_IMAGE_TAG}, ${FRONTEND_IMAGE_TAG}"
        }
        failure {
            echo "❌ Pipeline failed"
        }
    }
}
