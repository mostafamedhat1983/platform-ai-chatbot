// Monitoring Stack Deployment (Run ONCE per cluster)
// Deploys Metrics Server and Prometheus/Grafana

pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: kubectl
    image: alpine/k8s:1.30.7
    command: ['cat']
    tty: true
"""
        }
    }
    
    environment {
        MONITORING_NS = 'monitoring'
    }
    
    stages {
        stage('Deploy Metrics Server') {
            steps {
                container('kubectl') {
                    sh """
                        kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
                        echo "Metrics Server deployed, waiting for startup..."
                        sleep 30
                        kubectl top nodes || echo "Metrics not ready yet (this is normal, give it a few minutes)"
                    """
                }
            }
        }
        
        stage('Deploy Prometheus Stack') {
            steps {
                container('kubectl') {
                    sh """
                        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                        helm repo update
                        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
                          --namespace ${MONITORING_NS} \
                          --create-namespace \
                          --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
                          --set grafana.adminPassword=admin \
                          --set grafana.service.type=ClusterIP
                    """
                }
            }
        }
        
        stage('Deploy Grafana Ingress') {
            steps {
                container('kubectl') {
                    sh """
                        kubectl apply -f k8s/grafana-ingress.yaml
                    """
                }
            }
        }
        
        stage('Deploy Falco') {
            steps {
                container('kubectl') {
                    sh """
                        helm repo add falcosecurity https://falcosecurity.github.io/charts
                        helm repo update
                        helm upgrade --install falco falcosecurity/falco \
                          --namespace falco \
                          --create-namespace \
                          --set falco.grpc.enabled=true \
                          --set falco.grpcOutput.enabled=true \
                          --set falcosidekick.enabled=true \
                          --set falcosidekick.webui.enabled=true \
                          --set falcosidekick.webui.redis.enabled=true \
                          --set falcoExporter.enabled=true \
                          --set falcoExporter.serviceMonitor.enabled=true
                        echo "Falco deployed, waiting for startup..."
                        sleep 20
                    """
                }
            }
        }
        
        stage('Verify & Get Access') {
            steps {
                container('kubectl') {
                    sh """
                        echo "\\n=== Grafana Access ==="
                        kubectl get ingress grafana-ingress -n ${MONITORING_NS}
                        echo "URL: https://grafana.mostafa-medhat.online (after DNS setup)"
                        echo "Credentials: admin / admin"
                        echo "\\n=== Falco Access ==="
                        echo "Falcosidekick UI: kubectl port-forward -n falco svc/falco-falcosidekick-ui 2802:2802"
                        echo "Then open: http://localhost:2802"
                        echo "\\n=== Grafana Integration ==="
                        echo "Prometheus scrapes Falco metrics automatically via ServiceMonitor"
                        echo "Import Grafana dashboard ID: 11914 for Falco visualization"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "✅ Monitoring stack deployed. Access Grafana and verify metrics collection."
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
