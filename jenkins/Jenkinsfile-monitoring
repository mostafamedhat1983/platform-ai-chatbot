// Monitoring Stack Deployment (Run ONCE per cluster)
// Deploys Metrics Server and Prometheus/Grafana

pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: kubectl
    image: alpine/k8s:1.30.7
    command: ['cat']
    tty: true
"""
        }
    }
    
    environment {
        MONITORING_NS = 'monitoring'
    }
    
    stages {
        stage('Deploy Metrics Server') {
            steps {
                container('kubectl') {
                    sh """
                        kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
                        echo "Metrics Server deployed, waiting for startup..."
                        sleep 30
                        kubectl top nodes || echo "Metrics not ready yet (this is normal, give it a few minutes)"
                    """
                }
            }
        }
        
        stage('Deploy Prometheus Stack') {
            steps {
                container('kubectl') {
                    sh """
                        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                        helm repo update
                        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
                          --namespace ${MONITORING_NS} \
                          --create-namespace \
                          --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
                          --set grafana.adminPassword=admin \
                          --set grafana.service.type=ClusterIP
                    """
                }
            }
        }
        
        stage('Deploy Grafana Ingress') {
            steps {
                container('kubectl') {
                    sh """
                        helm upgrade --install grafana-ingress ./k8s \
                          -f k8s/values-${TARGET_ENVIRONMENT}.yaml \
                          --set chatbot.ingress.enabled=false \
                          --set grafana.ingress.enabled=true
                    """
                }
            }
        }
        
        stage('Verify & Get Access') {
            steps {
                container('kubectl') {
                    sh """
                        echo "\\n=== Grafana Access ==="
                        kubectl get ingress grafana-ingress -n ${MONITORING_NS}
                        echo "URL: https://grafana.mostafa-medhat.online (after DNS setup)"
                        echo "Credentials: admin / admin"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "✅ Monitoring stack deployed. Access Grafana and verify metrics collection."
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
