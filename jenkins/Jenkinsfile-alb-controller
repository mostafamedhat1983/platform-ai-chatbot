pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: helm
    image: alpine/helm:latest
    command: ['cat']
    tty: true
'''
        }
    }
    
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'prod'], description: 'Target environment')
    }
    
    stages {
        stage('Install AWS Load Balancer Controller') {
            steps {
                container('helm') {
                    script {
                        def clusterName = params.ENVIRONMENT == 'dev' ? 'platform-dev' : 'platform-prod'
                        
                        sh """
                            helm repo add eks https://aws.github.io/eks-charts
                            helm repo update
                            
                            helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
                              -n kube-system \
                              --set clusterName=${clusterName} \
                              --set serviceAccount.create=true \
                              --set serviceAccount.name=aws-load-balancer-controller
                        """
                    }
                }
            }
        }
        
        stage('Verify Installation') {
            steps {
                container('helm') {
                    sh """
                        echo "Waiting for controller pods to be ready..."
                        kubectl wait --for=condition=ready pod \
                          -l app.kubernetes.io/name=aws-load-balancer-controller \
                          -n kube-system \
                          --timeout=120s
                        
                        echo "AWS Load Balancer Controller installed successfully!"
                        kubectl get deployment -n kube-system aws-load-balancer-controller
                    """
                }
            }
        }
    }
}
